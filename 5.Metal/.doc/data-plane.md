# :abacus: Plan de données `data plane` 

:round_pushpin: Joindre un noeud 

À l'initialisation du plan de contrôle, un :tickets: jeton à été donné avec la commande `kubeadm`, récupérer cette commande.

Elle devrait ressembler à la suivante:

```
$ sudo kubeadm join betelgeuse.boreal.codes:6443 \
               --token 2pje0m.xl8voke0wisjymvp   \
               --discovery-token-ca-cert-hash sha256:27c4b80df3d468bfe13517750a265bb3a3c560871e1bf177cafb323070b7b4a6
```

:bulb: :tickets: Gestion des Jetons

Si vous avez perdu le :tickets: jeton, ou que le jeton a expiré

- [ ] Sur le :control_knobs: plan de contrôle, afficher la liste des :tickets: Jetons

Observer le champ `TTL` (Time To Live), il indique le temps restant avant expiration du jeton 

```
$ kubeadm token list
TOKEN                     TTL         EXPIRES                USAGES                   DESCRIPTION                                                EXTRA GROUPS
seg7l8.5b6iz1mpixhtool4   17h         2021-04-05T12:12:01Z   authentication,signing   The default bootstrap token generated by 'kubeadm init'.   system:bootstrappers:kubeadm:default-node-token
```

- [ ] Si les jetons ont tous expirés, regénérer un jeton avec les commandes ci-dessous

```
$ kubeadm token create --print-join-command
W0304 19:51:22.390054 2541130 configset.go:202] WARNING: kubeadm cannot validate component configs for API groups [kubelet.config.k8s.io kubeproxy.config.k8s.io]

kubeadm join betelgeuse.boreal.codes:6443 --token zlt7nb.lpd06ao1kxf4uwgm     --discovery-token-ca-cert-hash sha256:3aa3fe1dd88a80e7ea9e76408dd166947a606b7bd0f1ad089454ccf9a80c2365 
```

[:back:](../#abacus-les-plan-de-données-data-plane)


```
$ CA_CERT_HASH=`openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt \
    | openssl rsa -pubin -outform der 2>/dev/null \
    | openssl dgst -sha256 -hex \
    | sed 's/^.* //'`
```

```
$ TOKEN=<TOKEN PRIS DE LA LISTE>
```

$ CA_CERT_HASH="c41ff0c3608120eaf7599bc77f6bc72b1e75c46caa073bb28cba21ea1f86f5ef"
$ TOKEN="seg7l8.5b6iz1mpixhtool4"
$ CTL_PLANE="betelgeuse.boreal.codes"


```
$ sudo kubeadm join ${CTL_PLANE}:6443 --token ${TOKEN} --discovery-token-ca-cert-hash sha256:${CA_CERT_HASH}
```

# References

https://stackoverflow.com/questions/51126164/how-do-i-find-the-join-command-for-kubeadm-on-the-master
